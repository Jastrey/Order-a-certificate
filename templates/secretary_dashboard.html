{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <h2>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å —Å–µ–∫—Ä–µ—Ç–∞—Ä—è</h2>
    <p class="user-role">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <strong>–°–µ–∫—Ä–µ—Ç–∞—Ä—å</strong> | <a href="{{ url_for('secretary_logout') }}">–í—ã–π—Ç–∏</a></p>
    
    <div class="filters">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –º–µ—Å—Ç—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è...">
        <select id="statusFilter">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="–≤ —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="–≥–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
            <option value="–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
        </select>
        <button onclick="loadCertificates()" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>

    <div class="stats" id="statsContainer">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
    </div>

    <div class="certificates-table">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞</th>
                    <th>–ì—Ä—É–ø–ø–∞:</th>
                    <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                    <th>–ú–µ—Å—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="certificatesTable">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadCertificates() {
    const search = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    
    fetch(`/api/certificates?search=${encodeURIComponent(search)}&status=${encodeURIComponent(status)}`)
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById('certificatesTable');
            tableBody.innerHTML = '';
            
            data.forEach(cert => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${cert.id}</td>
                        <td>${cert.student_name}</td>
                        <td>${cert.student_group}</td>
                        <td>${cert.birth_date}</td>
                        <td>${cert.request_place}</td>
                        <td>${cert.quantity}</td>
                        <td>
                            <select class="status-select" data-id="${cert.id}">
                                <option value="–≤ —Ä–∞–±–æ—Ç–µ" ${cert.status === '–≤ —Ä–∞–±–æ—Ç–µ' ? 'selected' : ''}>–í —Ä–∞–±–æ—Ç–µ</option>
                                <option value="–≥–æ—Ç–æ–≤–æ" ${cert.status === '–≥–æ—Ç–æ–≤–æ' ? 'selected' : ''}>–ì–æ—Ç–æ–≤–æ</option>
                                <option value="–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ" ${cert.status === '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ' ? 'selected' : ''}>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                            </select>
                        </td>
                        <td>${cert.created_at}</td>
                        <td>
                            <button onclick="updateStatus(${cert.id})" class="btn btn-small">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </td>
                `;
                tableBody.appendChild(row);
            });
        });
    
    loadStats();
}

function loadStats() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ —Å–ø—Ä–∞–≤–æ–∫</h3>
                    <span>${data.total}</span>
                </div>
                <div class="stat-card">
                    <h3>–í —Ä–∞–±–æ—Ç–µ</h3>
                    <span>${data.in_work}</span>
                </div>
                <div class="stat-card">
                    <h3>–ì–æ—Ç–æ–≤–æ</h3>
                    <span>${data.ready}</span>
                </div>
                <div class="stat-card">
                    <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</h3>
                    <span>${data.rejected}</span>
                </div>
            `;
        });
}

function updateStatus(certificateId) {
    const select = document.querySelector(`.status-select[data-id="${certificateId}"]`);
    const newStatus = select.value;
    
    fetch(`/api/certificates/${certificateId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
        return response.json();
    })
    .then(data => {
        alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
        loadCertificates();
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadCertificates();
    
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(loadCertificates, 500);
    });
});
</script>
{% endblock %}
